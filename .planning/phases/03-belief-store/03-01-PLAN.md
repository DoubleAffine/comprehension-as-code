---
phase: 03-belief-store
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/comprehension/store/__init__.py
  - src/comprehension/store/repository.py
  - src/comprehension/store/migrations.py
  - tests/test_repository.py
autonomous: true

must_haves:
  truths:
    - "Comprehensions persist to SQLite and survive process restart"
    - "get(id) returns exact comprehension that was saved"
    - "Duplicate save (same ID) updates existing record"
  artifacts:
    - path: "src/comprehension/store/repository.py"
      provides: "SQLiteComprehensionRepository class"
      exports: ["SQLiteComprehensionRepository"]
    - path: "src/comprehension/store/migrations.py"
      provides: "Schema creation and versioning"
      exports: ["ensure_schema"]
    - path: "tests/test_repository.py"
      provides: "Repository operation tests"
      min_lines: 50
  key_links:
    - from: "src/comprehension/store/repository.py"
      to: "src/comprehension/schema/comprehension.py"
      via: "Comprehension model import"
      pattern: "from comprehension\\.schema import Comprehension"
    - from: "src/comprehension/store/repository.py"
      to: "sqlite3"
      via: "Database operations"
      pattern: "conn\\.execute"
---

<objective>
Implement SQLite repository for comprehension persistence with schema creation.

Purpose: Enable comprehensions to persist across sessions. This is the foundation for all belief store operations.
Output: Working repository that can save and retrieve comprehensions.
</objective>

<execution_context>
@/Users/ianphilipp/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianphilipp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-belief-store/03-RESEARCH.md

# Existing models
@src/comprehension/schema/comprehension.py
@src/comprehension/schema/confidence.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migrations and schema</name>
  <files>src/comprehension/store/__init__.py, src/comprehension/store/migrations.py</files>
  <action>
    Create src/comprehension/store/ directory and migrations.py:

    ```python
    def ensure_schema(conn: sqlite3.Connection) -> None:
        """Create tables and indexes if they don't exist."""
    ```

    Schema:
    - comprehensions table with columns: id (PK), domain, topic, confidence, created, updated, version, verified, data (JSON blob)
    - Indexes on domain, confidence, updated
    - Schema version tracking table
    - FTS5 virtual table for topic search (triggers in 03-02)

    Create __init__.py with imports for SQLiteComprehensionRepository (to be created in Task 2).
  </action>
  <verify>python -c "from comprehension.store.migrations import ensure_schema; print('Migration module loads')"</verify>
  <done>migrations.py creates comprehensions table with proper schema and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Implement SQLiteComprehensionRepository</name>
  <files>src/comprehension/store/repository.py, tests/test_repository.py</files>
  <action>
    Create SQLiteComprehensionRepository class with CRUD operations:

    ```python
    class SQLiteComprehensionRepository:
        def __init__(self, db_path: str | Path):
            # Stores path, calls _ensure_schema()

        def add(self, comprehension: Comprehension) -> None:
            # INSERT OR REPLACE, stores model_dump_json() in data column
            # Extracts indexed fields: id, domain, topic, confidence, created, updated, version, verified

        def get(self, id: str) -> Comprehension | None:
            # Returns deserialized Comprehension or None
            # Uses Pydantic model_validate_json()

        def delete(self, id: str) -> bool:
            # Removes by ID, returns True if deleted

        def count(self) -> int:
            # Returns total count
    ```

    Create tests/test_repository.py with test cases:
    - test_add_and_get: Save, retrieve, verify match
    - test_add_updates_existing: Second save updates, version increments
    - test_get_missing: Returns None for unknown ID
    - test_delete: Removes comprehension, get returns None
    - test_count: Tracks total stored
    - test_persists_across_sessions: Close conn, reopen, data still there
  </action>
  <verify>pytest tests/test_repository.py -v</verify>
  <done>All repository tests pass; comprehensions round-trip correctly through SQLite</done>
</task>

</tasks>

<verification>
```bash
# Run repository tests
pytest tests/test_repository.py -v

# Verify persistence
python -c "
from comprehension.store import SQLiteComprehensionRepository
from comprehension.schema import Comprehension, BeliefPrior, BeliefPosterior, ConfidenceLevel
from datetime import datetime, timezone
import tempfile
import os

with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
    db_path = f.name

repo = SQLiteComprehensionRepository(db_path)
comp = Comprehension(
    id='test-001',
    topic='Test persistence',
    domain='test',
    prior=BeliefPrior(statement='Initial', confidence=ConfidenceLevel.UNKNOWN, source='test'),
    observations=[],
    posterior=BeliefPosterior(statement='Updated', confidence=ConfidenceLevel.MEDIUM, update_reasoning='Test', observations_used=[]),
    created=datetime.now(timezone.utc),
    updated=datetime.now(timezone.utc),
)
repo.add(comp)
repo = None  # Close

repo2 = SQLiteComprehensionRepository(db_path)
loaded = repo2.get('test-001')
assert loaded is not None
assert loaded.topic == 'Test persistence'
print('Persistence verified!')
os.unlink(db_path)
"
```
</verification>

<success_criteria>
- All repository tests pass
- Comprehension round-trips through SQLite correctly
- Persistence survives connection close/reopen
- Schema includes proper indexes on domain, confidence, updated
</success_criteria>

<output>
After completion, create `.planning/phases/03-belief-store/03-01-SUMMARY.md`
</output>
