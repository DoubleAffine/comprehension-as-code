---
phase: 03-belief-store
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/comprehension/store/__init__.py
  - src/comprehension/store/repository.py
  - src/comprehension/store/migrations.py
  - tests/test_repository.py
autonomous: true

must_haves:
  truths:
    - "Comprehensions persist to SQLite and survive process restart"
    - "get(id) returns exact comprehension that was saved"
    - "Duplicate save (same ID) updates existing record"
  artifacts:
    - path: "src/comprehension/store/repository.py"
      provides: "SQLiteComprehensionRepository class"
      exports: ["SQLiteComprehensionRepository"]
    - path: "src/comprehension/store/migrations.py"
      provides: "Schema creation and versioning"
      exports: ["ensure_schema"]
    - path: "tests/test_repository.py"
      provides: "Repository operation tests"
      min_lines: 50
  key_links:
    - from: "src/comprehension/store/repository.py"
      to: "src/comprehension/schema/comprehension.py"
      via: "Comprehension model import"
      pattern: "from comprehension\\.schema import Comprehension"
    - from: "src/comprehension/store/repository.py"
      to: "sqlite3"
      via: "Database operations"
      pattern: "conn\\.execute"
---

<objective>
Implement SQLite repository for comprehension persistence with schema creation.

Purpose: Enable comprehensions to persist across sessions. This is the foundation for all belief store operations.
Output: Working repository that can save and retrieve comprehensions.
</objective>

<execution_context>
@/Users/ianphilipp/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianphilipp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-belief-store/03-RESEARCH.md

# Existing models
@src/comprehension/schema/comprehension.py
@src/comprehension/schema/confidence.py
</context>

<feature>
  <name>SQLite Comprehension Repository</name>
  <files>src/comprehension/store/repository.py, src/comprehension/store/migrations.py, tests/test_repository.py</files>
  <behavior>
    Repository provides CRUD operations for Comprehension persistence:

    1. add(comprehension) -> None
       - Inserts new or updates existing (INSERT OR REPLACE)
       - Stores full model as JSON in data column
       - Extracts indexed fields: id, domain, topic, confidence, created, updated, version, verified

    2. get(id) -> Comprehension | None
       - Returns deserialized Comprehension or None if not found
       - Uses Pydantic model_validate_json() for deserialization

    3. delete(id) -> bool
       - Removes comprehension by ID
       - Returns True if deleted, False if not found

    4. count() -> int
       - Returns total comprehension count

    Schema (migrations.py):
    - comprehensions table with indexed columns
    - FTS5 virtual table for topic search (triggers in 03-02)
    - Schema version tracking

    Test cases:
    - test_add_and_get: Save, retrieve, verify match
    - test_add_updates_existing: Second save updates, version increments
    - test_get_missing: Returns None for unknown ID
    - test_delete: Removes comprehension, get returns None
    - test_count: Tracks total stored
    - test_persists_across_sessions: Close conn, reopen, data still there
  </behavior>
  <implementation>
    1. Create src/comprehension/store/ directory
    2. migrations.py: ensure_schema(conn) creates tables and indexes
    3. repository.py: SQLiteComprehensionRepository class
       - __init__(db_path: str | Path) stores path, calls _ensure_schema()
       - Uses context manager for connection per operation
       - Stores comprehension.model_dump_json() in data column
       - Extracts indexed fields for efficient queries
  </implementation>
</feature>

<verification>
```bash
# Run repository tests
pytest tests/test_repository.py -v

# Verify persistence
python -c "
from comprehension.store import SQLiteComprehensionRepository
from comprehension.schema import Comprehension, BeliefPrior, BeliefPosterior, ConfidenceLevel
from datetime import datetime, timezone
import tempfile
import os

with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
    db_path = f.name

repo = SQLiteComprehensionRepository(db_path)
comp = Comprehension(
    id='test-001',
    topic='Test persistence',
    domain='test',
    prior=BeliefPrior(statement='Initial', confidence=ConfidenceLevel.UNKNOWN, source='test'),
    observations=[],
    posterior=BeliefPosterior(statement='Updated', confidence=ConfidenceLevel.MEDIUM, update_reasoning='Test', observations_used=[]),
    created=datetime.now(timezone.utc),
    updated=datetime.now(timezone.utc),
)
repo.add(comp)
repo = None  # Close

repo2 = SQLiteComprehensionRepository(db_path)
loaded = repo2.get('test-001')
assert loaded is not None
assert loaded.topic == 'Test persistence'
print('Persistence verified!')
os.unlink(db_path)
"
```
</verification>

<success_criteria>
- All repository tests pass
- Comprehension round-trips through SQLite correctly
- Persistence survives connection close/reopen
- Schema includes proper indexes on domain, confidence, updated
</success_criteria>

<output>
After completion, create `.planning/phases/03-belief-store/03-01-SUMMARY.md`
</output>
