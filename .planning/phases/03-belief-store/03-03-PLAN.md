---
phase: 03-belief-store
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/comprehension/store/__init__.py
  - src/comprehension/store/belief_store.py
  - src/comprehension/store/observation_index.py
  - tests/test_belief_store.py
  - tests/test_observation_index.py
autonomous: true

must_haves:
  truths:
    - "BeliefStore provides unified interface for save/query/update operations"
    - "Observation references remain in comprehension even after content is pruned"
    - "Storage grows with understanding (comprehension count), not evidence (observation count)"
    - "ObservationIndex tracks which observations have content vs. pruned"
  artifacts:
    - path: "src/comprehension/store/belief_store.py"
      provides: "BeliefStore facade class"
      exports: ["BeliefStore"]
    - path: "src/comprehension/store/observation_index.py"
      provides: "ObservationIndex for reference tracking"
      exports: ["ObservationIndex"]
    - path: "tests/test_belief_store.py"
      provides: "BeliefStore integration tests"
      min_lines: 40
    - path: "tests/test_observation_index.py"
      provides: "ObservationIndex tests"
      min_lines: 30
  key_links:
    - from: "src/comprehension/store/belief_store.py"
      to: "src/comprehension/store/repository.py"
      via: "Repository composition"
      pattern: "SQLiteComprehensionRepository"
    - from: "src/comprehension/store/belief_store.py"
      to: "src/comprehension/store/observation_index.py"
      via: "Index composition"
      pattern: "ObservationIndex"
    - from: "src/comprehension/store/observation_index.py"
      to: "src/comprehension/update/lifecycle.py"
      via: "Lifecycle state coordination"
      pattern: "from comprehension\\.update\\.lifecycle import"
---

<objective>
Create BeliefStore facade and ObservationIndex for memory-efficient belief management.

Purpose: Provide the main interface for the belief store system. BeliefStore wraps repository operations, and ObservationIndex enables observation content pruning while retaining references.
Output: Complete belief store system ready for agent integration.
</objective>

<execution_context>
@/Users/ianphilipp/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianphilipp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-belief-store/03-RESEARCH.md
@.planning/phases/03-belief-store/03-01-SUMMARY.md
@.planning/phases/03-belief-store/03-02-SUMMARY.md

# Foundation
@src/comprehension/store/repository.py
@src/comprehension/store/queries.py
@src/comprehension/update/lifecycle.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ObservationIndex for reference tracking</name>
  <files>src/comprehension/store/observation_index.py, tests/test_observation_index.py</files>
  <action>
    Create ObservationIndex class that tracks observation references and pruning status:

    ```python
    class ObservationIndex:
        """Tracks observation references for memory efficiency.

        Observations are ephemeral; comprehensions persist. This index tracks:
        1. Which comprehensions reference each observation (observation_id -> [comp_ids])
        2. Which observations still have content vs. have been pruned

        Key insight: comprehension.observations list retains IDs even after
        content is pruned. This index enables safe pruning decisions.
        """

        def __init__(self, db_path: str | Path):
            # Uses same SQLite DB as repository

        def record_reference(self, observation_id: str, comprehension_id: str) -> None:
            """Record that comprehension references this observation."""

        def mark_content_pruned(self, observation_id: str) -> None:
            """Mark observation content as deleted (reference remains)."""

        def is_content_available(self, observation_id: str) -> bool:
            """Check if observation content still exists."""

        def get_referencing_comprehensions(self, observation_id: str) -> List[str]:
            """Get comprehension IDs that reference this observation."""

        def get_prunable(self, lifecycle: ObservationLifecycle) -> Set[str]:
            """Get observations safe to prune.

            Returns observation IDs that are:
            1. INCORPORATED in lifecycle (used by comprehension)
            2. Not already pruned

            Args:
                lifecycle: ObservationLifecycle from Phase 2

            Returns:
                Set of observation IDs whose content can be deleted
            """
    ```

    Schema (in same DB):
    - observation_refs table: observation_id, comprehension_id (composite PK)
    - observation_pruned table: observation_id, pruned_at

    Tests:
    - test_record_reference: Creates link between observation and comprehension
    - test_multiple_references: One observation, multiple comprehensions
    - test_mark_pruned: Sets pruned status
    - test_is_content_available: Returns False after pruning
    - test_get_referencing_comprehensions: Returns correct list
    - test_get_prunable: Integration with ObservationLifecycle
  </action>
  <verify>pytest tests/test_observation_index.py -v</verify>
  <done>ObservationIndex tracks references and pruning status; integrates with ObservationLifecycle</done>
</task>

<task type="auto">
  <name>Task 2: Create BeliefStore facade</name>
  <files>src/comprehension/store/belief_store.py, src/comprehension/store/__init__.py, tests/test_belief_store.py</files>
  <action>
    Create BeliefStore class that provides the main interface for belief persistence:

    ```python
    class BeliefStore:
        """Main interface for belief persistence.

        Provides a unified API for:
        - Saving and updating comprehensions
        - Querying by domain, topic, confidence, recency
        - Managing observation references

        This is the public interface; repository/index are implementation details.
        """

        def __init__(self, db_path: str | Path):
            """Initialize belief store with SQLite database path."""
            self._repository = SQLiteComprehensionRepository(db_path)
            self._observation_index = ObservationIndex(db_path)

        # Persistence
        def save(self, comprehension: Comprehension) -> None:
            """Save or update a comprehension.

            Also updates observation index with any new observation references.
            """

        def get(self, comprehension_id: str) -> Comprehension | None:
            """Get comprehension by ID."""

        def delete(self, comprehension_id: str) -> bool:
            """Delete comprehension."""

        # Retrieval
        def find_by_domain(self, domain: str) -> List[Comprehension]:
            """Find all comprehensions in a domain."""

        def find_by_topic(self, query: str, limit: int = 10) -> List[Comprehension]:
            """Full-text search on topic."""

        def find_by_confidence(self, min_confidence: ConfidenceLevel) -> List[Comprehension]:
            """Find comprehensions at or above confidence level."""

        def find_recent(self, limit: int = 10) -> List[Comprehension]:
            """Get most recently updated comprehensions."""

        def find(
            self,
            domain: str | None = None,
            min_confidence: ConfidenceLevel | None = None,
            topic_query: str | None = None,
            limit: int = 20
        ) -> List[Comprehension]:
            """Combined query with multiple filters."""

        # Observation management
        def get_observation_index(self) -> ObservationIndex:
            """Access observation index for pruning operations."""

        # Stats
        def stats(self) -> dict:
            """Get store statistics: comprehension_count, domains, etc."""
    ```

    Update __init__.py to export:
    - BeliefStore
    - SQLiteComprehensionRepository
    - ObservationIndex

    Tests:
    - test_save_and_get: Basic round-trip
    - test_save_updates_observation_index: References tracked
    - test_retrieval_methods_delegate: All find_* methods work
    - test_stats: Returns correct counts
  </action>
  <verify>pytest tests/test_belief_store.py -v</verify>
  <done>BeliefStore provides unified interface; exports available from comprehension.store</done>
</task>

</tasks>

<verification>
```bash
# Run all store tests
pytest tests/test_repository.py tests/test_observation_index.py tests/test_belief_store.py -v

# Verify memory efficiency principle
python -c "
from comprehension.store import BeliefStore
from comprehension.schema import Comprehension, BeliefPrior, BeliefPosterior, ConfidenceLevel
from datetime import datetime, timezone
import tempfile
import os

with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
    db_path = f.name

store = BeliefStore(db_path)

# Create comprehension with observation references
comp = Comprehension(
    id='comp-001',
    topic='Memory efficiency test',
    domain='test',
    prior=BeliefPrior(statement='Initial', confidence=ConfidenceLevel.UNKNOWN, source='test'),
    observations=['obs-001', 'obs-002', 'obs-003'],  # References to observations
    posterior=BeliefPosterior(
        statement='Observations inform beliefs',
        confidence=ConfidenceLevel.HIGH,
        update_reasoning='Multiple observations confirmed',
        observations_used=['obs-001', 'obs-002', 'obs-003']
    ),
    created=datetime.now(timezone.utc),
    updated=datetime.now(timezone.utc),
)
store.save(comp)

# Observation references are in comprehension
loaded = store.get('comp-001')
assert len(loaded.observations) == 3

# But observation content is separate (can be pruned)
obs_index = store.get_observation_index()
for obs_id in loaded.observations:
    obs_index.mark_content_pruned(obs_id)

# Comprehension still has references after pruning
loaded = store.get('comp-001')
assert len(loaded.observations) == 3
assert all(not obs_index.is_content_available(obs_id) for obs_id in loaded.observations)

print('Memory efficiency verified: references retained, content pruned!')
os.unlink(db_path)
"
```
</verification>

<success_criteria>
- BeliefStore provides clean facade over repository and index
- ObservationIndex tracks references independently from content
- Observation references persist in comprehension even after content pruning
- All retrieval methods accessible through BeliefStore
- Module exports work: `from comprehension.store import BeliefStore`
</success_criteria>

<output>
After completion, create `.planning/phases/03-belief-store/03-03-SUMMARY.md`
</output>
