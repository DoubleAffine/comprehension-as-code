---
phase: 03-belief-store
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/comprehension/store/repository.py
  - src/comprehension/store/migrations.py
  - src/comprehension/store/queries.py
  - tests/test_repository.py
autonomous: true

must_haves:
  truths:
    - "Comprehensions can be retrieved by domain"
    - "Comprehensions can be searched by topic using full-text search"
    - "Comprehensions can be filtered by minimum confidence level"
    - "Comprehensions can be retrieved by recency (most recently updated first)"
    - "Multi-dimensional queries work (domain + confidence + limit)"
  artifacts:
    - path: "src/comprehension/store/repository.py"
      provides: "Retrieval methods on SQLiteComprehensionRepository"
      exports: ["SQLiteComprehensionRepository"]
    - path: "src/comprehension/store/queries.py"
      provides: "Query builders and confidence ordering"
      exports: ["CONFIDENCE_ORDER", "build_filter_query"]
    - path: "src/comprehension/store/migrations.py"
      provides: "FTS5 virtual table and triggers"
      contains: "CREATE VIRTUAL TABLE"
  key_links:
    - from: "src/comprehension/store/repository.py"
      to: "src/comprehension/store/queries.py"
      via: "Query building helpers"
      pattern: "from .queries import"
    - from: "src/comprehension/store/migrations.py"
      to: "comprehensions_fts"
      via: "FTS5 virtual table"
      pattern: "comprehensions_fts"
---

<objective>
Implement multi-dimensional retrieval: domain, topic (FTS5), confidence, and recency.

Purpose: Enable retrieval by relevance instead of "load all". Agents can query beliefs by domain, search topics, filter by confidence, and get recent updates.
Output: Repository methods for all retrieval dimensions with proper indexing.
</objective>

<execution_context>
@/Users/ianphilipp/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianphilipp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-belief-store/03-RESEARCH.md
@.planning/phases/03-belief-store/03-01-SUMMARY.md

# Repository foundation
@src/comprehension/store/repository.py
@src/comprehension/store/migrations.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FTS5 schema and queries module</name>
  <files>src/comprehension/store/migrations.py, src/comprehension/store/queries.py</files>
  <action>
    Update migrations.py to add FTS5 virtual table:
    - Create comprehensions_fts virtual table with Porter stemmer tokenizer
    - Add INSERT/UPDATE/DELETE triggers to keep FTS5 in sync
    - Check for FTS5 availability

    Create queries.py with helper functions:
    ```python
    CONFIDENCE_ORDER = {
        ConfidenceLevel.UNKNOWN: 0,
        ConfidenceLevel.LOW: 1,
        ConfidenceLevel.MEDIUM: 2,
        ConfidenceLevel.HIGH: 3
    }

    def build_filter_query(...) -> str:
        """Build SQL query with optional filters."""

    def build_confidence_filter(min_level: ConfidenceLevel) -> str:
        """Build SQL fragment for confidence filtering."""
    ```
  </action>
  <verify>python -c "from comprehension.store.queries import CONFIDENCE_ORDER, build_filter_query; print('Queries module loads')"</verify>
  <done>FTS5 virtual table exists with triggers; queries.py provides helper functions</done>
</task>

<task type="auto">
  <name>Task 2: Implement retrieval methods on repository</name>
  <files>src/comprehension/store/repository.py, tests/test_repository.py</files>
  <action>
    Extend SQLiteComprehensionRepository with retrieval methods:

    ```python
    def find_by_domain(self, domain: str) -> List[Comprehension]:
        # Returns all comprehensions in domain, ordered by updated DESC

    def find_by_topic(self, query: str, limit: int = 10) -> List[Comprehension]:
        # FTS5 search with BM25 ranking

    def find_by_confidence(self, min_confidence: ConfidenceLevel) -> List[Comprehension]:
        # Uses CONFIDENCE_ORDER mapping, ordered by updated DESC

    def find_recent(self, limit: int = 10) -> List[Comprehension]:
        # Most recently updated, ordered by updated DESC

    def find(self, domain: str | None, min_confidence: ConfidenceLevel | None,
             topic_query: str | None, limit: int = 20) -> List[Comprehension]:
        # Combined filters, any can be None
    ```

    Add tests to tests/test_repository.py:
    - test_find_by_domain: Filters correctly
    - test_find_by_domain_empty: Returns empty list if no match
    - test_find_by_topic_fts: Full-text search works
    - test_find_by_topic_stemming: "learning" matches "learn"
    - test_find_by_confidence: HIGH returns HIGH only, MEDIUM returns HIGH+MEDIUM
    - test_find_recent: Returns correct order, respects limit
    - test_find_combined: Domain + confidence + limit work together
  </action>
  <verify>pytest tests/test_repository.py -v -k "find"</verify>
  <done>All retrieval tests pass; FTS5 search works with stemming; combined queries functional</done>
</task>

</tasks>

<verification>
```bash
# Run all repository tests
pytest tests/test_repository.py -v

# Verify FTS5 search
python -c "
from comprehension.store import SQLiteComprehensionRepository
from comprehension.schema import Comprehension, BeliefPrior, BeliefPosterior, ConfidenceLevel
from datetime import datetime, timezone
import tempfile
import os

with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
    db_path = f.name

repo = SQLiteComprehensionRepository(db_path)

# Create test comprehensions
for i, (topic, domain, conf) in enumerate([
    ('Python error handling patterns', 'python', ConfidenceLevel.HIGH),
    ('JavaScript async await best practices', 'javascript', ConfidenceLevel.MEDIUM),
    ('Python type hints for functions', 'python', ConfidenceLevel.LOW),
]):
    comp = Comprehension(
        id=f'test-{i:03d}',
        topic=topic,
        domain=domain,
        prior=BeliefPrior(statement='Initial', confidence=ConfidenceLevel.UNKNOWN, source='test'),
        observations=[],
        posterior=BeliefPosterior(statement='Updated', confidence=conf, update_reasoning='Test', observations_used=[]),
        created=datetime.now(timezone.utc),
        updated=datetime.now(timezone.utc),
    )
    repo.add(comp)

# Test searches
python_comps = repo.find_by_domain('python')
assert len(python_comps) == 2, f'Expected 2 Python comps, got {len(python_comps)}'

topic_results = repo.find_by_topic('Python')
assert len(topic_results) >= 2, f'Expected >=2 topic matches, got {len(topic_results)}'

high_conf = repo.find_by_confidence(ConfidenceLevel.HIGH)
assert len(high_conf) == 1, f'Expected 1 HIGH confidence, got {len(high_conf)}'

print('All retrieval tests passed!')
os.unlink(db_path)
"
```
</verification>

<success_criteria>
- All retrieval tests pass
- FTS5 search returns relevant results with stemming
- Confidence filtering respects ordinal comparison
- Combined queries work correctly
- Results always ordered by recency
</success_criteria>

<output>
After completion, create `.planning/phases/03-belief-store/03-02-SUMMARY.md`
</output>
