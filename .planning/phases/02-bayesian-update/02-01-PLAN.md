---
phase: 02-bayesian-update
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/comprehension/update/__init__.py
  - src/comprehension/update/confidence_rules.py
  - tests/test_confidence_rules.py
autonomous: true

must_haves:
  truths:
    - "Confirming evidence increases confidence (LOW -> MEDIUM -> HIGH)"
    - "Contradicting evidence decreases confidence (HIGH -> MEDIUM -> LOW)"
    - "Neutral evidence does not change confidence"
    - "Confidence transitions follow explicit, deterministic rules"
  artifacts:
    - path: "src/comprehension/update/confidence_rules.py"
      provides: "Confidence transition state machine"
      exports: ["EvidenceType", "compute_confidence_transition", "CONFIDENCE_TRANSITIONS"]
    - path: "tests/test_confidence_rules.py"
      provides: "Test coverage for all confidence transitions"
      min_lines: 50
  key_links:
    - from: "src/comprehension/update/confidence_rules.py"
      to: "src/comprehension/schema/confidence.py"
      via: "import"
      pattern: "from.*schema.*import ConfidenceLevel"
---

<objective>
Implement confidence transition logic as a deterministic state machine.

Purpose: Confidence level changes must follow explicit rules, not ad-hoc LLM judgment. This ensures Bayesian updates are systematic and predictable. The state machine codifies: confirming evidence increases confidence, contradicting evidence decreases it.

Output: `EvidenceType` enum, `CONFIDENCE_TRANSITIONS` mapping, and `compute_confidence_transition()` pure function with full test coverage.
</objective>

<execution_context>
@/Users/ianphilipp/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianphilipp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bayesian-update/02-RESEARCH.md
@src/comprehension/schema/confidence.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for confidence transitions</name>
  <files>tests/test_confidence_rules.py, src/comprehension/update/__init__.py</files>
  <action>
Create `src/comprehension/update/__init__.py` (empty for now).

Create `tests/test_confidence_rules.py` with comprehensive tests BEFORE implementation:

```python
import pytest
from comprehension.schema.confidence import ConfidenceLevel
from comprehension.update.confidence_rules import (
    EvidenceType,
    compute_confidence_transition,
    CONFIDENCE_TRANSITIONS,
)

class TestEvidenceType:
    """EvidenceType enum exists with expected values."""

    def test_confirming_exists(self):
        assert EvidenceType.CONFIRMING.value == "confirming"

    def test_contradicting_exists(self):
        assert EvidenceType.CONTRADICTING.value == "contradicting"

    def test_neutral_exists(self):
        assert EvidenceType.NEUTRAL.value == "neutral"


class TestConfirmingEvidence:
    """Confirming evidence increases confidence."""

    def test_unknown_to_low(self):
        result = compute_confidence_transition(
            ConfidenceLevel.UNKNOWN, EvidenceType.CONFIRMING
        )
        assert result == ConfidenceLevel.LOW

    def test_low_to_medium(self):
        result = compute_confidence_transition(
            ConfidenceLevel.LOW, EvidenceType.CONFIRMING
        )
        assert result == ConfidenceLevel.MEDIUM

    def test_medium_to_high(self):
        result = compute_confidence_transition(
            ConfidenceLevel.MEDIUM, EvidenceType.CONFIRMING
        )
        assert result == ConfidenceLevel.HIGH

    def test_high_stays_high(self):
        result = compute_confidence_transition(
            ConfidenceLevel.HIGH, EvidenceType.CONFIRMING
        )
        assert result == ConfidenceLevel.HIGH  # Can't go higher


class TestContradictingEvidence:
    """Contradicting evidence decreases confidence."""

    def test_high_to_medium(self):
        result = compute_confidence_transition(
            ConfidenceLevel.HIGH, EvidenceType.CONTRADICTING
        )
        assert result == ConfidenceLevel.MEDIUM

    def test_medium_to_low(self):
        result = compute_confidence_transition(
            ConfidenceLevel.MEDIUM, EvidenceType.CONTRADICTING
        )
        assert result == ConfidenceLevel.LOW

    def test_low_stays_low(self):
        result = compute_confidence_transition(
            ConfidenceLevel.LOW, EvidenceType.CONTRADICTING
        )
        assert result == ConfidenceLevel.LOW  # Stays low, belief may flip

    def test_unknown_to_low(self):
        # Contradicting evidence on unknown = we learned something (low confidence)
        result = compute_confidence_transition(
            ConfidenceLevel.UNKNOWN, EvidenceType.CONTRADICTING
        )
        assert result == ConfidenceLevel.LOW


class TestNeutralEvidence:
    """Neutral evidence does not change confidence."""

    @pytest.mark.parametrize("level", [
        ConfidenceLevel.UNKNOWN,
        ConfidenceLevel.LOW,
        ConfidenceLevel.MEDIUM,
        ConfidenceLevel.HIGH,
    ])
    def test_neutral_no_change(self, level):
        result = compute_confidence_transition(level, EvidenceType.NEUTRAL)
        assert result == level


class TestTransitionsComplete:
    """All valid combinations have defined transitions."""

    def test_all_combinations_defined(self):
        for conf in ConfidenceLevel:
            for evidence in EvidenceType:
                # Should not raise, should return valid ConfidenceLevel
                result = compute_confidence_transition(conf, evidence)
                assert isinstance(result, ConfidenceLevel)
```

Tests must FAIL because `confidence_rules.py` doesn't exist yet.
  </action>
  <verify>
Run `pytest tests/test_confidence_rules.py -v` and confirm all tests FAIL with ImportError (module doesn't exist).
  </verify>
  <done>Tests written and failing (RED state)</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement confidence transition state machine</name>
  <files>src/comprehension/update/confidence_rules.py</files>
  <action>
Create `src/comprehension/update/confidence_rules.py` with minimal implementation to pass tests:

```python
"""Confidence transition rules for Bayesian updates.

Defines explicit rules for how confidence levels change based on evidence type.
This is a deterministic state machine, not LLM judgment.
"""

from enum import Enum
from typing import Tuple

from comprehension.schema.confidence import ConfidenceLevel


class EvidenceType(str, Enum):
    """Classification of how observation relates to belief."""
    CONFIRMING = "confirming"      # Supports existing belief
    CONTRADICTING = "contradicting" # Challenges existing belief
    NEUTRAL = "neutral"            # Doesn't clearly support or contradict


# Confidence transition rules
# Format: (current_confidence, evidence_type) -> new_confidence
CONFIDENCE_TRANSITIONS: dict[Tuple[ConfidenceLevel, EvidenceType], ConfidenceLevel] = {
    # From UNKNOWN
    (ConfidenceLevel.UNKNOWN, EvidenceType.CONFIRMING): ConfidenceLevel.LOW,
    (ConfidenceLevel.UNKNOWN, EvidenceType.CONTRADICTING): ConfidenceLevel.LOW,
    (ConfidenceLevel.UNKNOWN, EvidenceType.NEUTRAL): ConfidenceLevel.UNKNOWN,

    # From LOW
    (ConfidenceLevel.LOW, EvidenceType.CONFIRMING): ConfidenceLevel.MEDIUM,
    (ConfidenceLevel.LOW, EvidenceType.CONTRADICTING): ConfidenceLevel.LOW,
    (ConfidenceLevel.LOW, EvidenceType.NEUTRAL): ConfidenceLevel.LOW,

    # From MEDIUM
    (ConfidenceLevel.MEDIUM, EvidenceType.CONFIRMING): ConfidenceLevel.HIGH,
    (ConfidenceLevel.MEDIUM, EvidenceType.CONTRADICTING): ConfidenceLevel.LOW,
    (ConfidenceLevel.MEDIUM, EvidenceType.NEUTRAL): ConfidenceLevel.MEDIUM,

    # From HIGH
    (ConfidenceLevel.HIGH, EvidenceType.CONFIRMING): ConfidenceLevel.HIGH,
    (ConfidenceLevel.HIGH, EvidenceType.CONTRADICTING): ConfidenceLevel.MEDIUM,
    (ConfidenceLevel.HIGH, EvidenceType.NEUTRAL): ConfidenceLevel.HIGH,
}


def compute_confidence_transition(
    current: ConfidenceLevel,
    evidence_type: EvidenceType
) -> ConfidenceLevel:
    """Apply confidence transition rule.

    Args:
        current: Current confidence level
        evidence_type: How observation relates to belief

    Returns:
        New confidence level after applying transition rule
    """
    return CONFIDENCE_TRANSITIONS.get(
        (current, evidence_type),
        current  # Default: no change
    )
```

Update `src/comprehension/update/__init__.py`:
```python
from .confidence_rules import (
    EvidenceType,
    compute_confidence_transition,
    CONFIDENCE_TRANSITIONS,
)

__all__ = ["EvidenceType", "compute_confidence_transition", "CONFIDENCE_TRANSITIONS"]
```
  </action>
  <verify>
Run `pytest tests/test_confidence_rules.py -v` and confirm ALL tests PASS.
  </verify>
  <done>All confidence transition tests passing (GREEN state)</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_confidence_rules.py -v` - all tests pass
2. `python -c "from comprehension.update import EvidenceType, compute_confidence_transition"` - imports work
3. Confirming evidence path: UNKNOWN -> LOW -> MEDIUM -> HIGH
4. Contradicting evidence path: HIGH -> MEDIUM -> LOW
5. Neutral evidence: no change at any level
</verification>

<success_criteria>
- [ ] EvidenceType enum exists with CONFIRMING, CONTRADICTING, NEUTRAL
- [ ] CONFIDENCE_TRANSITIONS mapping covers all 12 combinations (4 levels x 3 types)
- [ ] compute_confidence_transition() is a pure function
- [ ] All 12+ tests pass
- [ ] Confirming evidence increases confidence
- [ ] Contradicting evidence decreases confidence
- [ ] Neutral evidence preserves confidence
</success_criteria>

<output>
After completion, create `.planning/phases/02-bayesian-update/02-01-SUMMARY.md`
</output>
