---
phase: 01-comprehension-format
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - spec/examples/sample_observation.md
  - spec/examples/sample_comprehension.md
  - tests/comprehension/__init__.py
  - tests/comprehension/test_schema_validation.py
  - src/comprehension/parser/__init__.py
  - src/comprehension/parser/markdown_parser.py
autonomous: true

must_haves:
  truths:
    - "Sample comprehension document validates against Pydantic schema"
    - "Sample observation document validates against Pydantic schema"
    - "Parser can load comprehension documents from Markdown+YAML files"
    - "Tests prove schema validation works correctly"
  artifacts:
    - path: "spec/examples/sample_comprehension.md"
      provides: "Reference example of valid comprehension document"
      contains: "spec: comprehension/v1"
    - path: "spec/examples/sample_observation.md"
      provides: "Reference example of valid observation document"
      contains: "spec: observation/v1"
    - path: "tests/comprehension/test_schema_validation.py"
      provides: "Pytest tests for schema validation"
      exports: ["test_comprehension_samples_valid", "test_observation_samples_valid"]
    - path: "src/comprehension/parser/markdown_parser.py"
      provides: "Frontmatter parsing and validation"
      exports: ["load_comprehension", "load_observation"]
  key_links:
    - from: "tests/comprehension/test_schema_validation.py"
      to: "spec/examples/"
      via: "pytest parametrize"
      pattern: "SAMPLE_DIR.*glob"
    - from: "src/comprehension/parser/markdown_parser.py"
      to: "src/comprehension/schema"
      via: "import"
      pattern: "from comprehension.schema import"
---

<objective>
Create sample documents that validate against schemas and tests that prove validation works.

Purpose: Sample documents serve as reference implementations that agents can copy. Tests prove the schema validation actually works and catches invalid documents. This completes Phase 1 by demonstrating the format works end-to-end.

Output: Sample comprehension and observation documents in `spec/examples/`, a Markdown parser utility, and pytest tests that validate samples against schemas.
</objective>

<execution_context>
@/Users/ianphilipp/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ianphilipp/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-comprehension-format/01-RESEARCH.md
@.planning/phases/01-comprehension-format/01-01-SUMMARY.md
@.planning/phases/01-comprehension-format/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sample observation and comprehension documents</name>
  <files>spec/examples/sample_observation.md, spec/examples/sample_comprehension.md</files>
  <action>
Create spec/examples/ directory.

Create sample_observation.md:
```yaml
---
spec: observation/v1
type: observation
id: obs-001
timestamp: 2026-02-13T10:25:00Z
source: agent/api-integration-agent
event: "HTTP POST to /api/auth/login returned 404 Not Found"
context:
  project: example-project
  task: authenticate-user
  expected: 200
trace_ref: null
---

# Observation: REST auth endpoint not found

Agent attempted POST to `/api/auth/login` with valid credentials and received HTTP 404.

## Raw Response

```
HTTP/1.1 404 Not Found
Content-Type: application/json
{"error": "Not Found"}
```
```

Create sample_comprehension.md:
```yaml
---
spec: comprehension/v1
type: comprehension
id: comp-api-auth-001
topic: Authentication API endpoint location
domain: api-integration

prior:
  statement: "The authentication API uses REST endpoints at /api/auth/*"
  confidence: medium
  source: documentation
  reasoning: "Based on initial API documentation provided during project setup"

observations:
  - obs-001
  - obs-002

posterior:
  statement: "The authentication API has migrated to GraphQL; REST endpoints no longer exist"
  confidence: high
  update_reasoning: "REST endpoint failure (404) combined with successful GraphQL mutation confirms migration. Documentation is outdated."
  observations_used:
    - obs-001
    - obs-002

created: 2026-02-13T10:30:00Z
updated: 2026-02-13T14:15:00Z
version: 2
verified: true
---

# Authentication API Location

## Summary

The authentication API has **migrated from REST to GraphQL**. The original REST endpoints at `/api/auth/*` no longer exist.

## Evidence

1. REST POST to `/api/auth/login` returned 404 (obs-001)
2. GraphQL mutation `authenticate` succeeded with same credentials (obs-002)

## Implications

- All authentication calls must use GraphQL client
- Project documentation needs updating
- Other REST API assumptions should be verified

## Related

- This comprehension supersedes any prior beliefs about REST auth endpoints
```
  </action>
  <verify>
- `test -f spec/examples/sample_observation.md` exists
- `test -f spec/examples/sample_comprehension.md` exists
- `grep -q "spec: observation/v1" spec/examples/sample_observation.md`
- `grep -q "spec: comprehension/v1" spec/examples/sample_comprehension.md`
  </verify>
  <done>Sample documents exist with valid frontmatter structure</done>
</task>

<task type="auto">
  <name>Task 2: Create Markdown parser with frontmatter validation</name>
  <files>src/comprehension/parser/__init__.py, src/comprehension/parser/markdown_parser.py</files>
  <action>
Create src/comprehension/parser/ directory.

Create markdown_parser.py:
```python
"""Parse comprehension and observation documents from Markdown with YAML frontmatter."""

import frontmatter
from pathlib import Path
from typing import Union
from pydantic import ValidationError

from comprehension.schema import Comprehension, Observation


def load_comprehension(filepath: Union[str, Path]) -> Comprehension:
    """Load and validate a comprehension document.

    Args:
        filepath: Path to Markdown file with YAML frontmatter

    Returns:
        Validated Comprehension model

    Raises:
        ValueError: If document fails validation
        FileNotFoundError: If file doesn't exist
    """
    with open(filepath, 'r') as f:
        doc = frontmatter.load(f)

    try:
        return Comprehension(**doc.metadata)
    except ValidationError as e:
        raise ValueError(f"Invalid comprehension document {filepath}: {e}")


def load_observation(filepath: Union[str, Path]) -> Observation:
    """Load and validate an observation document.

    Args:
        filepath: Path to Markdown file with YAML frontmatter

    Returns:
        Validated Observation model

    Raises:
        ValueError: If document fails validation
        FileNotFoundError: If file doesn't exist
    """
    with open(filepath, 'r') as f:
        doc = frontmatter.load(f)

    try:
        return Observation(**doc.metadata)
    except ValidationError as e:
        raise ValueError(f"Invalid observation document {filepath}: {e}")
```

Create parser/__init__.py:
```python
from .markdown_parser import load_comprehension, load_observation

__all__ = ["load_comprehension", "load_observation"]
```
  </action>
  <verify>
- `python -c "from comprehension.parser import load_comprehension, load_observation; print('Parser imports OK')"`
  </verify>
  <done>Markdown parser exists that validates documents against Pydantic schemas</done>
</task>

<task type="auto">
  <name>Task 3: Create pytest tests for schema validation</name>
  <files>tests/comprehension/__init__.py, tests/comprehension/test_schema_validation.py</files>
  <action>
Create tests/comprehension/ directory.

Create tests/comprehension/__init__.py (empty).

Create test_schema_validation.py:
```python
"""Tests for comprehension and observation schema validation."""

import pytest
from pathlib import Path

from comprehension.parser import load_comprehension, load_observation
from comprehension.schema import Comprehension, Observation, ConfidenceLevel


SAMPLE_DIR = Path(__file__).parent.parent.parent / "spec" / "examples"


class TestSampleDocuments:
    """Test that sample documents validate against schemas."""

    @pytest.mark.parametrize("filepath", list(SAMPLE_DIR.glob("sample_comprehension*.md")))
    def test_comprehension_samples_valid(self, filepath):
        """All sample comprehension documents must validate against schema."""
        comp = load_comprehension(filepath)

        # Verify structure
        assert comp.id is not None
        assert comp.prior is not None
        assert comp.posterior is not None
        assert comp.posterior.confidence in ConfidenceLevel
        assert len(comp.observations) > 0 or comp.prior.source == "training"

    @pytest.mark.parametrize("filepath", list(SAMPLE_DIR.glob("sample_observation*.md")))
    def test_observation_samples_valid(self, filepath):
        """All sample observation documents must validate against schema."""
        obs = load_observation(filepath)

        # Verify structure
        assert obs.id is not None
        assert obs.timestamp is not None
        assert obs.source is not None
        assert obs.event is not None


class TestSchemaValidation:
    """Test schema validation catches invalid documents."""

    def test_comprehension_requires_prior(self):
        """Comprehension must have prior belief."""
        from comprehension.schema import Comprehension, BeliefPosterior, ConfidenceLevel
        from datetime import datetime
        from pydantic import ValidationError

        with pytest.raises(ValidationError):
            Comprehension(
                id="test",
                topic="test",
                domain="test",
                # missing prior
                observations=[],
                posterior=BeliefPosterior(
                    statement="test",
                    confidence=ConfidenceLevel.LOW,
                    update_reasoning="test",
                    observations_used=[]
                ),
                created=datetime.now(),
                updated=datetime.now()
            )

    def test_confidence_must_be_valid_level(self):
        """Confidence must be HIGH, MEDIUM, LOW, or UNKNOWN."""
        from comprehension.schema import BeliefPrior, ConfidenceLevel
        from pydantic import ValidationError

        with pytest.raises(ValidationError):
            BeliefPrior(
                statement="test",
                confidence="very_high",  # invalid
                source="test"
            )

    def test_observation_requires_timestamp(self):
        """Observation must have timestamp."""
        from comprehension.schema import Observation
        from pydantic import ValidationError

        with pytest.raises(ValidationError):
            Observation(
                id="test",
                # missing timestamp
                source="test",
                event="test"
            )


class TestConfidenceLevels:
    """Test confidence level definitions."""

    def test_confidence_levels_exist(self):
        """All four confidence levels must exist."""
        assert ConfidenceLevel.HIGH.value == "high"
        assert ConfidenceLevel.MEDIUM.value == "medium"
        assert ConfidenceLevel.LOW.value == "low"
        assert ConfidenceLevel.UNKNOWN.value == "unknown"

    def test_confidence_is_string_enum(self):
        """Confidence levels must be string values for natural language."""
        assert isinstance(ConfidenceLevel.HIGH.value, str)
```

Run tests to verify: `pytest tests/comprehension/ -v`
  </action>
  <verify>
- `pytest tests/comprehension/test_schema_validation.py -v` passes all tests
- Tests cover: sample document validation, missing field detection, invalid confidence handling
  </verify>
  <done>Pytest tests exist and pass, proving schema validation works correctly</done>
</task>

</tasks>

<verification>
1. Sample documents exist: `ls spec/examples/sample_*.md`
2. Parser works: `python -c "from comprehension.parser import load_comprehension; c = load_comprehension('spec/examples/sample_comprehension.md'); print(c.posterior.confidence)"`
3. All tests pass: `pytest tests/comprehension/ -v`
4. Schema validation catches errors: Invalid documents raise ValidationError (tested by test_schema_validation.py)
</verification>

<success_criteria>
- [ ] spec/examples/sample_observation.md exists with valid frontmatter
- [ ] spec/examples/sample_comprehension.md exists with valid frontmatter
- [ ] Parser loads and validates documents against Pydantic schemas
- [ ] Pytest tests pass for sample document validation
- [ ] Tests verify schema catches invalid documents (missing fields, invalid confidence)
- [ ] All Phase 1 success criteria satisfied: format defined, schema distinguishes types, Bayesian structure, samples validate
</success_criteria>

<output>
After completion, create `.planning/phases/01-comprehension-format/01-03-SUMMARY.md`
</output>
